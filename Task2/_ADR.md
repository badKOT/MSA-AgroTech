# ADR-002: Проектирование системы мониторинга кормов и воды.

**Статус:** ⚠️ На рассмотрении
**Участники:** Архитектор, Tech Lead Edge, Tech Lead Cloud, DevOps
**Дата:** 2025-08-10

---

## 1. Контекст + Требования

Необходимо настроить мониторинг запасов еды и прогнозирование расходов, мониторинг систем фильтрации воды, а также систему управления кормушками и поилками.

Как реализовать систему мониторинга воды и еды и управления кормушек?

Система мониторинга запасов еды и прогнозирования расходов. Не требует real-time обновлений. Необходимо следить за датчиками, обновлять прогнозы по расходу. В цифровой платформе уже имеется аналитический модуль. Данные в него попадают через IoT-шлюз.

Система мониторинга состояния систем фильтрации воды. Скорее всего при превышении нормы потребуется быстрая реакция для минимизации потенциального ущерба. Более real-time сценарий.

Система управления кормушками и поилками. Необходимо обеспечить работу с низким лагом между командой и действием. Обеспечить возможность работы с устройствами разных производителей.

Для использования аналитической платформы нужно отправлять данные в IoT-шлюз.
Все срочные метрики обрабатываются на ферме. Есть несрочные метрики, которые можно отправлять несколько раз в день, когда есть подключение к интернету. Нет необходимости передавать real-time данные. Нужно несколько раз в день передавать большие пакеты метрик.

---

## 2. Решение

### Описание решения

Система мониторинга запасов еды и прогнозирования расходов:
Переиспользовать аналитическую платформу, добавить необходимые дашборды. Данные сохранять в локальное хранилище. Для использования аналитической платформы нужно отправлять данные в IoT-шлюз.

Система мониторинга состояния системы фильтрации воды:
Реализовать систему контроля локально на ферме, чтобы исключить возможные задержки при передаче метрик и получении команд от центрального дата-центра. Использовать Modbus-совместимые устройства. Существуют контроллеры, способные отдавать команды на основе входящих данных, например ADAM 6000 от Advantech. Подключить его (или похожее устройство) к датчикам, к кормушкам и поилкам, и добавить орган управления для возможности ручного контроля.
Данные записывать в локальное хранилище.

Система управления кормушками и поилками:
Радиоволны (LoRaWAN, Cellular при наличии покрытия) или Modbus? Modbus из-за распространенности.
Добавить брокер сообщений:
1. При расширении новые кормушки/поилки подключаются к брокеру, это проще чем service discovery. 
2. Если устройство offline, команда не потеряется, будет исполнена при следующем подключении.
3. Возможность контролировать все устройства одним общим топиком.
Высокая пропускная способность не нужна, нужна простота и минималистичность. Использовать MQTT - распространен в IoT, super lightweight, очень прост в использовании.

Для использования аналитической платформы нужно отправлять данные в IoT-шлюз.
Все срочные метрики обрабатываются на ферме. Есть несрочные метрики, которые можно отправлять несколько раз в день, когда есть подключение к интернету. Нет необходимости передавать real-time данные. Нужно несколько раз в день передавать большие пакеты метрик.
Использовать TCP. Он отлично подойдет для такого применения. Можно использовать HTTPS для обеспечения безопасности передаваемых данных.

---

## 3. Риски

**Риск**: Отказ локального контроллера приведет к потере возможности аварийного реагирования на аномалии фильтрации воды и управления кормушками/поилками.
**Меры**:
- Ввести горячий резервный контроллер с автоматическим переключением по Modbus-Heartbeat (keep-alive).
- Ускорить время восстановления контроллера. Для этого раз в сутки выгружать конфигурацию контроллера в Git-репозиторий.

**Риск**: Накопление несрочных метрик в локальном хранилище при длительном отсутствии интернета может привести к переполнению диска, потере данных или сбою ОС.
**Меры**:
- Настроить ротацию логов и TTL-политики (например, удаление данных старше 7 дней автоматически, если нет подтверждённой доставки в IoT-шлюз).
- Объединять метрики за смежные периоды времени, если их значения меняются на уровне погрешности (потребует написания сервиса с этой логикой). Альтернативное решение: при достижении определенного бэклога (3 дня) не сохранять метрику, если значение последней отличается от новой на уровне погрешности.
